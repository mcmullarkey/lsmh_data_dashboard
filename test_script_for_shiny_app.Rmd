---
title: "Test Script for Shiny App"
author: "Michael Mullarkey"
date: "4/28/2021"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")
## setting working directory
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, warning = FALSE, message = FALSE, include = FALSE)

```

```{r loading packages}

if(!require(tidyverse)){install.packages('tidyverse')}
library(tidyverse)
if(!require(skimr)){install.packages('skimr')}
library(skimr)
if(!require(glue)){install.packages('glue')}
library(glue)
if(!require(diffdf)){install.packages('diffdf')}
library(diffdf)

```

```{r reading in the data}

# Want a function that reads in list of dataframes

# find all file names ending in .csv 
files <- dir(pattern = "*.csv")

# Reading in all the files into a list of dataframes and doing initial selecting down of variables relevant to the dashboard

data_list <- files %>%
  map(read_csv) %>% 
  map(~dplyr::select(.x, contains("ethnicity"),contains("race"),contains("age"),contains("sex"),contains("gender"),contains("orientation"),contains("cond"),
                     contains("qual"),contains("like"),contains("dislike"),contains("pfs"),contains("pswq"),contains("cdi"),contains("idas"),contains("phq"),contains("mfq"),
                     contains("ss_choice_factor"),contains("sitb"),contains("identify_diff_gender_than_bio_sex_factor"))) %>% 
  map(~dplyr::select(.x, -contains("tim"))) %>% 
  print()

# Breaking out individual datasets to do data cleaning that's necessary for individual dataframes https://stackoverflow.com/questions/59169631/split-a-list-into-separate-data-frame-in-r

map(data_list, ~tibble(.x)) %>%
    set_names(str_c("df_", 1:4)) %>% 
    list2env(.GlobalEnv)

```

```{r clean empower}

# Cleaning Empower data

empower <- df_1 %>% 
  dplyr::rename(racial_identity = parent_ethnicity) %>% 
  rowwise() %>% 
  mutate(sgm = any(c_across(c(parent_gender_agender,parent_gender_intersex, parent_gender_other:parent_gender_notsure)))) %>% 
  ungroup() %>% 
  mutate(race_minoritized = factor(case_when(
    
    str_detect(racial_identity, "White") == TRUE ~ "No",
    str_detect(racial_identity, "White") == FALSE &  str_detect(parent_ethnicity_other_text, "white") ~ "No",
    TRUE ~ "Yes"
    
    )),
         randomized = factor(ifelse(is.na(condition), "No", "Yes")),
         qual_feed = factor(ifelse(is.na(pfs_liked), "No", "Yes")),
         sitb_assess = factor("No"),
         non_rand_treat = factor("No"),
         rec_ssi = ifelse(randomized == "Yes" | non_rand_treat == "Yes", "Yes", "No"),
         age = 18, # We don't know the age but want these folks to be included in the dashboard for folks looking for adults
         parent_report = factor("Yes"),
         self_report = factor("Yes")) %>% 
  dplyr::select(age, race_minoritized, sgm, sitb_assess, qual_feed, randomized, non_rand_treat, rec_ssi, self_report, parent_report) %>% 
  print()

```

```{r clean cope}

# Cleaning COPE data

cope <- df_2 %>% 
  #dplyr::rename(racial_identity = parent_ethnicity) %>% 
  rowwise() %>% 
  mutate(gen_minoritized = any(c_across(c(b_dem_gender_not_sure:b_dem_gender_male_to_female_transgender_mtf, b_dem_gender_transgender))),
         orien_minoritized = factor(case_when(
           
          str_detect(b_dem_orientation, "Heterosexual/Straight") == TRUE ~ "No",
          is.na(b_dem_orientation) ~ NA_character_,
          TRUE ~ "Yes"
           
         )),
         sgm = as.logical(case_when(
           
           gen_minoritized == TRUE | orien_minoritized == "Yes" ~ TRUE,
           gen_minoritized == FALSE & orien_minoritized == "No" ~ FALSE,
           TRUE ~ NA
           
         )),
         race_minoritized = any(c_across(c(b_dem_race_american_indian_or_alaska_native:b_dem_race_native_hawaiian_or_other_pacific_islander, b_dem_race_black_african_american,b_dem_race_other_specify)))) %>% 
  ungroup() %>% 
  mutate(randomized = factor(ifelse(is.na(condition), "No", "Yes")),
         qual_feed = factor(ifelse(is.na(pi_pfs_like), "No", "Yes")),
         sitb_assess = factor(ifelse(is.na(b_sitbi_2), "No", "Yes")),
         non_rand_treat = factor("No"),
         rec_ssi = ifelse(randomized == "Yes" | non_rand_treat == "Yes", "Yes", "No"),
         age = b_screener_age, # We don't know the age but want these folks to be included in the dashboard for folks looking for adults
         parent_report = factor("No"),
         self_report = factor("Yes")) %>% 
  dplyr::select(age, race_minoritized, sgm, gen_minoritized, orien_minoritized, sitb_assess, qual_feed, randomized, non_rand_treat, rec_ssi, self_report, parent_report) %>% 
  print()


```
```{r clean cope}

# Cleaning COPE data

cope <- df_3 %>% 
  #dplyr::rename(racial_identity = parent_ethnicity) %>% 
  rowwise() %>% 
  mutate(gen_minoritized = any(c_across(c(b_dem_gender_not_sure:b_dem_gender_male_to_female_transgender_mtf, b_dem_gender_transgender))),
         orien_minoritized = factor(case_when(
           
          str_detect(b_dem_orientation, "Heterosexual/Straight") == TRUE ~ "No",
          is.na(b_dem_orientation) ~ NA_character_,
          TRUE ~ "Yes"
           
         )),
         sgm = as.logical(case_when(
           
           gen_minoritized == TRUE | orien_minoritized == "Yes" ~ TRUE,
           !is.na(gen_minoritized) & !is.na(orien_minoritized) ~ NA,
           TRUE ~ FALSE
           
         )),
         race_minoritized = any(c_across(c(b_dem_race_american_indian_or_alaska_native:b_dem_race_native_hawaiian_or_other_pacific_islander, b_dem_race_black_african_american,b_dem_race_other_specify)))) %>% 
  ungroup() %>% 
  mutate(randomized = factor(ifelse(is.na(condition), "No", "Yes")),
         qual_feed = factor(ifelse(is.na(pi_pfs_like), "No", "Yes")),
         sitb_assess = factor(ifelse(is.na(b_sitbi_2), "No", "Yes")),
         non_rand_treat = factor("No"),
         rec_ssi = ifelse(randomized == "Yes" | non_rand_treat == "Yes", "Yes", "No"),
         age = b_screener_age, # We don't know the age but want these folks to be included in the dashboard for folks looking for adults
         parent_report = factor("No"),
         self_report = factor("Yes")) %>% 
  dplyr::select(age, race_minoritized, sgm, sitb_assess, qual_feed, randomized, non_rand_treat, rec_ssi, self_report, parent_report) %>% 
  print()

glimpse(df_2)


```
