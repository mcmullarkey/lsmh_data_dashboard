---
title: "Test Script for Shiny App"
author: "Michael Mullarkey"
date: "4/28/2021"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")
## setting working directory
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, warning = FALSE, message = FALSE, include = FALSE)

```

```{r loading packages}

if(!require(tidyverse)){install.packages('tidyverse')}
library(tidyverse)
if(!require(skimr)){install.packages('skimr')}
library(skimr)
if(!require(glue)){install.packages('glue')}
library(glue)
if(!require(diffdf)){install.packages('diffdf')}
library(diffdf)

```

```{r reading in the data}

# Want a function that reads in list of dataframes

# find all file names ending in .csv 
files <- dir(pattern = "*.csv")

# Reading in all the files into a list of dataframes and doing initial selecting down of variables relevant to the dashboard

data_list <- files %>%
  map(read_csv) %>% 
  map(~dplyr::select(.x, contains("ethnicity"),contains("race"),contains("age"),contains("sex"),contains("gender"),contains("cond"),
                     contains("qual"),contains("like"),contains("dislike"),contains("pfs")),contains("pswq"),contains("cdi"),contains("idas"),contains("mfq"),
                     contains("ss_choice_factor"),contains("stib"),contains("identify_diff_gender_than_bio_sex_factor")) %>% 
  map(~dplyr::select(.x, -contains("tim"))) %>% 
  print()

# Breaking out individual datasets to do data cleaning that's necessary for individual dataframes https://stackoverflow.com/questions/59169631/split-a-list-into-separate-data-frame-in-r

map(data_list, ~tibble(.x)) %>%
    set_names(str_c("df_", 1:4)) %>% 
    list2env(.GlobalEnv)

# Cleaning Empower data

empower <- df_1 %>% 
  dplyr::rename(racial_identity = parent_ethnicity) %>% 
  rowwise() %>% 
  mutate(sgm = any(c_across(c(parent_gender_agender,parent_gender_intersex, parent_gender_other:parent_gender_notsure)))) %>% 
  ungroup() %>% 
  mutate(race_minoritized = factor(case_when(
    
    str_detect(racial_identity, "White") == TRUE ~ "No",
    str_detect(racial_identity, "White") == FALSE &  str_detect(parent_ethnicity_other_text, "white") ~ "No",
    TRUE ~ "Yes"
    
    )),
         randomized = factor(ifelse(is.na(condition), "No", "Yes")),
         qual_feed = factor(ifelse(is.na(pfs_liked), "No", "Yes")),
         sitb_assess = factor("No"),
         non_rand_treat = factor("No"),
         rec_ssi = ifelse(randomized == "Yes" | non_rand_treat == "Yes", "Yes", "No"),
         age = 18, # We don't know the age but want these folks to be included in the dashboard for folks looking for adults
         parent_report = factor("Yes"),
         self_report = factor("Yes")) %>% 
  dplyr::select(age, race_minoritized, sgm, sitb_assess, qual_feed, randomized, non_rand_treat, rec_ssi, self_report, parent_report) %>% 
  print()


```

